---
id: servicelist
title: 业务组件
---

# 业务组件

### 组件介绍

#### gateway

业务网关。

网关用于接受所有业务请求，反向代理到小程序平台中的具体业务服务处理，所有业务接口统一由此暴露出去。

网关上会配置jwt、rate-limiting、监控、链路跟踪以及自定义开发等插件，根据业务需要做相关校验或者拦截处理。



#### account-system

角色管理模块。

小程序平台两个主要角色是机构方和运营方，运营方对机构方进行审核、审批、管控等。使用小程序平台之前，需要机构方进行注册、申请。



#### app-gray-statistics-center

灰度数据查看中心模块。

查看小程序灰度数据详情，包括：用户分布区域、用户使用终端类型、异常次数、打开次数，以及已上架和灰度版本对比情况。



#### app-manage-svr

小程序管理模块。

该模块是对小程序整个生存信息的管理服务，其中包括小程序创建、小程序信息维护、小程序审核、小程序上下架、应用创建、应用关联小程序这些子任务。该模块是运行时直接调用获取小程序详情（包括小程序描述、logo、下载包等）的入口和出口，所以也是小程序访问量最大的核心模块之一。



#### app-search

小程序搜索模块。



#### app-spider

数据统计模块。



#### applet-build-manager

小程序编译工程模块。



#### applet-build

前端小程序编译工程模块。



#### article-pub-center

小程序文章发布中心模块。

用于运行端发布通告、文章、期刊等。



#### audit-manage-svr

待办中心模块。



#### auth-checker

鉴权核查模块。



#### basic-pack-svr

基础库服务模块。

本服务主要为记录 SDK 运行时、基础库、凡泰助手的版本信息。



#### control-manager

SDK 控制管理模块。

SDK 获取配置信息，需要后端统一管理。



#### data-clean

数据加工模块



#### data-report

数据上报模块。

本服务主要为操作日志和日志上报服务，操作日志和数据上报接口将收集获取的数据丢入 Kafka，由另外专门的协程来消费处理，最终录入 Elasticsearch，提供给业务做各种搜索和统计。



#### data-static

数据统计模块。



#### device-security

设备安全管理模块。

用于在账号登录的时候，生产 refresh token、jwt。



#### domain-manager

域名管理模块。

该模块是为了对小程序访问的域名进行控制，域名分为：服务域名、业务域名、白名单域名。

1. 服务域名：小程序运行的时候，需要对小程序发行方的服务器进行访问，该访问的地址也就是这里所说的服务域名。

2. 业务域名：小程序运行的时候，除了对服务域名访问之外，还需要对第三方域名进行访问，第三方域名要求合规化，那么需要改业务域名进行合规校验，也就是，业务域名需要校验文件进行校验才可以进行访问。

3. 白名单域名：白名单域名，指的是运营审核方确定合规并且可以正常访问，无需校验的域名访问，例如：证监会、百度等。



#### feedback-svr

投诉反馈模块。

本服务主要记录用户投诉、举报、产品建议信息服务。



#### help-center-svr

帮助中心模块。



#### license-checker

License 校验中心模块。

License 用于决定小程序平台的部分功能，例如小程序数量、应用数量、灰度发布数量等。



#### netdisk-proxy

网盘中间层服务模块。

本服务主要为网盘服务提供一个中间层鉴权服务。



#### notify

通知中心模块。

可以发布运营端通知和机构端消息。



#### open-api

数据上报服务模块。

本服务主要为对外开发接口提供统一接入服务。



#### rule-engine-svr

规则引擎服务模块。

本服务主要为灰度发布、定制发布进行规则的配置和校验。



#### sdk-manager

SDK 审核管理模块。

在运营端对企业端提交的SDK进行审核，在企业端提交 SDK 进行审核。



#### verify-code-gateway

发送验证码网关模块。

可以配置网关，将短信验证码发送给指定的短信渠道，例如：腾讯云、客户自己的短信服务等。



### 中间件与基建

#### Consul

FinClip后端采用微服务架构开发模式，在微服务中，服务治理是非常重要的一环。服务通过注册到服务中心，以 供其他服务寻得接又调用地址，从而实现架构内部的服务间调用。FinClip采用Consul作为服务治理中心，在部分 场景，Consul还充当配置中心的作用。

Consul分为Server节点和Client节点，在我们使用的架构中，K8S集群中的每个节点会部署普通节点(client agent)， 在Kubernetes集群外的宿主机上部署的三个Server节点 (server节点是数据集群，普通agent只负责请求转发和心跳检测等)。

架构图如下所示：

![consul](/img/consul.png)

在这样的架构中， Consul服务端使用Raft选举，因此最少三个节点，且宕机数量不可超过半数，推荐单数节点，例如3、5、7。：

* Server节点部署在宿主机之中，使用docker-compose启动
* Client节点部署在Kubernetes中，使用DaemonSet部署。
* 集群必须 (N / 2) + 1个节点存活

* 当集群内LEADER节点宕机时，会发生选举，产生新的LEADER节点，集群可用
* 当节点宕机数量大于Server / 2 时，集群不可用
* 可扩容/缩容



#### Redis

&emsp;FinClip采用Redis实现数据缓存功能，Redis 是一种开源(BSD 许可)、内存中数据结构存储的开源软件，通常 用作数据库、缓存和消息代理。 Redis 提供了诸如字符串、散列、列表、集合、带范围查询的排序集合、位图、 超级日志、地理空间索引和流等数据结构。 Redis 内置复制、Lua 脚本、LRU 驱逐、事务和不同级别的磁盘持久 化，并通过 Redis Sentinel 和自动提供高可用性，在实际部署中，我们推荐客户采用Redis的集群模式，以实现高 可用性和可扩展性。



Redis 是一个高性能的 key-value 数据库。目前我们部署的 Redis 集群部署是这样的：

* 集群共 *6* 个 Redis 实例
* 集群内部 *3* 主 *3* 从模式
* Redis 版本：6.0

我们采用三台机服务器部署，每台服务器 2 个 Redis 实例，对于更高的 QPS 要求，我们推荐使用 6 台服务器部署，每个服务器一个 Redis 实例。在总共 6 个 Redis 实例里，其中三个 Master 节点，三个 Slave 节点，且默认情况下 Master 与 Slave 会自动避免部署在同一台机器中。

Redis 的拓扑图如下：

![redis](/img/redis.png)

在这样的架构中：

* 当集群内一个主节点宕机时，其从节点会自动升级成为主节点
* 集群中从节点宕机不影响集群使用
* 可扩容 / 缩容

* 当集群内一个主节点宕机时，其从节点会自动升级成为主节点
* 集群中从节点宕机不影响集群使用
* 经测试，Redis 从宕机不影响业务使用，Redis 发生主从切换时，会有秒级影响。



#### MongoDB

FinClip 业务数据存储支持多种数据库，通常我们采用MongoDB作为主要的存储方案，MongoDB 是一个基于分 布式文件存储的数据库，由 C++ 语言编写，旨在为 WEB 应用提供可扩展的高性能数据存储解决方案，且支持多 机房部署。 在实际部署中，我们推荐客户使用MongoDB的副本集、分片模式，以满足可扩展、高可用的运维需 求。


![mongo](/img/mongo.png)

副本集是一组维护相同数据集合的 mongod实例。副本集包含多个数据承载节点和一个可选的仲裁节点。在数据承载节点中，有且仅有一个成员为主节点，其他节点为从节点。



#### Elasticsearch

&emsp;对于用户行为数据，FinClip 采用 ElasticSearch 进行存储、检索和分析。Elasticsearch 是一种分布式 RESTful 搜 索和分析引擎，能够处理越来越多的用例。作为 Elastic Stack 的核心，它集中存储您的数据，以实现闪电般的快 速搜索、微调相关性和可轻松扩展的强大分析。

![es](/img/es.png)



#### Kafka

在高并发系统中，使用消息队列进行异步处理是惯用的模式。FinClip采用Kafka作为消息队列中间件，基于 Kafka的多分区设计，可以实现高吞吐量消息队列管理。Apache Kafka 是一个开源分布式事件流平台，被数千家 公司用于高性能数据管道、流分析、数据集成和关键任务应用程序。

同样地，在生产系统中，我们推荐使用多节点部署Kafka集群，从而实现高吞吐量、高可用已经可扩展的运维功 能:

![kafka](/img/kafka.png)



#### Zookeeper

kafka的协调选举节点，负责维护kafka节点状态。



#### MinIO

FinClip还用到对象存储，用于存储小程序包、图片等静态资源文件。对象存储是业界非常成熟的存储方案，在客 户的实际部署中，我们支持使用第三方对象存储，例如腾讯云COS、阿里云OSS、AWS S3等等。除此之外，在私 有化部署中，我们可以使用Minio进行部署对象存储服务服务器。

![minio](/img/minio.png)



### 附加组件

#### Ansible

提供自动化部署功能



#### Docker

提供基本的容器环境



#### Docker-Compose

为中间件集群建立提供必要的编排工具



#### Rancher

用于建立 Kubernetes 集群，并提供一个易用性极强的集群综合管理面板



#### Registry

用于**临时性**存储、分发在部署过程中以及后续运行时需要用到的 Docker 镜像。



#### Tinygit

用于**临时性**存储、分发在部署过程中以及后续运行时需要用到的 Helm 编排文件，以 Git 代码的方式储存。